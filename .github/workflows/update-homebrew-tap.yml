name: Update Homebrew Tap

on:
  release:
    types: [published]

jobs:
  update-tap:
    runs-on: ubuntu-latest
    steps:
      - name: Check out homebrew-tap repository
        uses: actions/checkout@v4
        with:
          repository: vrischmann/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update Homebrew formula
        run: |
          # Get the release tag (e.g., v2.3.0) from the GitHub event that triggered the workflow.
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          # Get the version number by removing the 'v' prefix (e.g., 2.3.0).
          VERSION=$(echo "$RELEASE_TAG" | sed 's/v//')

          echo "Updating formula to version $VERSION ($RELEASE_TAG)"

          # Download the checksums file generated by GoReleaser from the new release assets.
          curl -L "https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/checksums.txt" -o checksums.txt

          # Extract the specific sha256 checksums for the darwin builds.
          AMD64_SHA=$(grep "darwin_amd64" checksums.txt | cut -d' ' -f1)
          ARM64_SHA=$(grep "darwin_arm64" checksums.txt | cut -d' ' -f1)

          echo "AMD64 Checksum: $AMD64_SHA"
          echo "ARM64 Checksum: $ARM64_SHA"

          FORMULA_FILE="Formula/tasks.rb"

          # 1. Update the version line.
          sed -i "s/version \"[0-9.]*\"/version \"${VERSION}\"/" "$FORMULA_FILE"

          # 2. Update the Intel (amd64) block. The sed command operates only on lines between the two patterns.
          sed -i "/if Hardware::CPU.intel?/,/else/ s|url \".*\"|url \"https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/tasks_${VERSION}_darwin_amd64.tar.gz\"|" "$FORMULA_FILE"
          sed -i "/if Hardware::CPU.intel?/,/else/ s/sha256 \"[a-f0-9]*\"/sha256 \"${AMD64_SHA}\"/" "$FORMULA_FILE"

          # 3. Update the Apple Silicon (arm64) block.
          sed -i "/else/,/end/ s|url \".*\"|url \"https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/tasks_${VERSION}_darwin_arm64.tar.gz\"|" "$FORMULA_FILE"
          sed -i "/else/,/end/ s/sha256 \"[a-f0-9]*\"/sha256 \"${ARM64_SHA}\"/" "$FORMULA_FILE"

          echo "--- Formula content after update ---"
          cat "$FORMULA_FILE"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          commit-message: "Update tasks to version ${{ github.event.release.tag_name }}"
          title: "Update tasks to version ${{ github.event.release.tag_name }}"
          body: |
            This PR was automatically generated to update the `tasks` formula to version `${{ github.event.release.tag_name }}`.
          # The name of the new branch to create.
          branch: "update/tasks-${{ github.event.release.tag_name }}"
          # Set to true to automatically delete the branch after the PR is merged.
          delete-branch: true
